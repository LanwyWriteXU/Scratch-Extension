// Name: Cyberexplorer's Toolbox
// ID: cyberexplorertoolbox
// Description: 一些有用的东西塞在一块了
// Author: Cyberexplorer
// License: MIT

// 多国l10n支持

Scratch.translate.setup({
  "zh-cn": {
      "_Cyberexplorer's Toolbox": "赛博猫猫的工具箱",
      "_IndexedDB": "本地存储",
      "_store [key] as [value]": "设置键 [key] 的值为 [value]",
      "_set description of [key] to [description]": "设置键 [key] 的描述为 [description]",
      "_set project description to [description]": "设置项目描述为 [description]",
      "_get [type] of [key]": "获取键 [key] 的 [type]",
      "_clear storage": "清除存储空间",
      "_delete key [key]": "删除键 [key]",
      "_get number of keys": "获取键的数量",
      "_get [part] of the nth key-value pair [n]": "获取第 [n] 个键值对的 [part]",
      "_value": "值",
      "_description": "描述",
      "_key": "键",
      "_No value found for key [key]": "未找到键 [key] 对应的值",
      "_No description found for key [key]": "未找到键 [key] 对应的描述",
      "_Storage cleared": "存储空间已清除",
      "_Key [key] deleted": "键 [key] 已删除",
      "_No key found": "未找到键",
      "_project description": "项目描述",
      "_Set the database name to [databaseName]": "切换数据库存储空间名称为 [databaseName]",
      "_Get current database name": "当前数据库名称",
      "_Get current database size": "当前数据库大小",
      "_Is database [databaseName] exists": "名为 [databaseName] 的数据库是否存在",
      "_Get all key-value pairs": "所有键值对",
      "_Create new database [databaseName]": "创建新数据库 [databaseName]",
      "_Delete database [databaseName]": "删除数据库 [databaseName]",
      "_Operation": "操作",
      "_Opens the file of [TYPE] and returns as [CONTENT_TYPE]": "打开 [TYPE] 类型的文件并作为 [CONTENT_TYPE] 返回",
      "_openFile": "打开文件",
      "_text": "文本",
      "_binary text": "二进制文本",
      "_DataURL": "DataURL"
  },
  "ru": {
      "_Cyberexplorer's Toolbox": "Набор инструментов Cyberexplorer",
      "_IndexedDB": "Локальное хранилище",
      "_store [key] as [value]": "Установить значение ключа [key] как [value]",
      "_set description of [key] to [description]": "Установить описание ключа [key] как [description]",
      "_set project description to [description]": "Установить описание проекта как [description]",
      "_get [type] of [key]": "Получить [type] ключа [key]",
      "_clear storage": "Очистить хранилище",
      "_delete key [key]": "Удалить ключ [key]",
      "_get number of keys": "Получить количество ключей",
      "_get [part] of the nth key-value pair [n]": "Получить [part] n-й пары ключ-значение [n]",
      "_value": "Значение",
      "_description": "Описание",
      "_key": "Ключ",
      "_No value found for key [key]": "Не найдено значение для ключа [key]",
      "_No description found for key [key]": "Не найдено описание для ключа [key]",
      "_Storage cleared": "Хранилище очищено",
      "_Key [key] deleted": "Ключ [key] удален",
      "_No key found": "Не найден ключ",
      "_project description": "Описание проекта",
      "_Set the database name to [databaseName]": "Переименовать базу данных в [databaseName]",
      "_Get current database name": "Текущее имя базы данных",
      "_Get current database size": "Текущий размер базы данных",
      "_Is database [databaseName] exists": "Существует ли база данных [databaseName]",
      "_Get all key-value pairs": "Получить все пары ключ-значение",
      "_Create new database [databaseName]": "Создать новую базу данных [databaseName]",
      "_Delete database [databaseName]": "Удалить базу данных [databaseName]",
      "_Operation": "Операция",
      "_Opens the file of [TYPE] and returns as [CONTENT_TYPE]": "Открыть файл типа [TYPE] и вернуть как [CONTENT_TYPE]",
      "_openFile": "Открыть файл",
      "_text": "Текст",
      "_binary text": "Бинарный текст",
      "_DataURL": "DataURL"
  },
  "ja": {
      "_Cyberexplorer's Toolbox": "サイバーエクスプローラーのツールボックス",
      "_IndexedDB": "ローカルストレージ",
      "_store [key] as [value]": "キー [key] の値を [value] に設定する",
      "_set description of [key] to [description]": "キー [key] の説明を [description] に設定する",
      "_set project description to [description]": "プロジェクトの説明を [description] に設定する",
      "_get [type] of [key]": "キー [key] の [type] を取得する",
      "_clear storage": "ストレージをクリアする",
      "_delete key [key]": "キー [key] を削除する",
      "_get number of keys": "キーの数を取得する",
      "_get [part] of the nth key-value pair [n]": "n番目のキー-値ペア [n] の [part] を取得する",
      "_value": "値",
      "_description": "説明",
      "_key": "キー",
      "_No value found for key [key]": "キー [key] に対応する値が見つかりません",
      "_No description found for key [key]": "キー [key] に対応する説明が見つかりません",
      "_Storage cleared": "ストレージがクリアされました",
      "_Key [key] deleted": "キー [key] が削除されました",
      "_No key found": "キーが見つかりません",
      "_project description": "プロジェクトの説明",
      "_Set the database name to [databaseName]": "データベース名を [databaseName] に設定する",
      "_Get current database name": "現在のデータベース名を取得する",
      "_Get current database size": "現在のデータベースサイズを取得する",
      "_Is database [databaseName] exists": "データベース [databaseName] が存在するかどうか",
      "_Get all key-value pairs": "すべてのキー-値ペアを取得する",
      "_Create new database [databaseName]": "新しいデータベース [databaseName] を作成する",
      "_Delete database [databaseName]": "データベース [databaseName] を削除する",
      "_Operation": "操作",
      "_Opens the file of [TYPE] and returns as [CONTENT_TYPE]": "[TYPE] 型のファイルを開いて [CONTENT_TYPE] として返す",
      "_openFile": "ファイルを開く",
      "_text": "テキスト",
      "_binary text": "バイナリーテキスト",
      "_DataURL": "DataURL"
  },
  "es": {
      "_Cyberexplorer's Toolbox": "Caja de herramientas de Cyberexplorer",
      "_IndexedDB": "Almacenamiento local",
      "_store [key] as [value]": "Establecer el valor de la clave [key] como [value]",
      "_set description of [key] to [description]": "Establecer la descripción de la clave [key] como [description]",
      "_set project description to [description]": "Establecer la descripción del proyecto como [description]",
      "_get [type] of [key]": "Obtener el [type] de la clave [key]",
      "_clear storage": "Eliminar el almacenamiento",
      "_delete key [key]": "Eliminar la clave [key]",
      "_get number of keys": "Obtener el número de claves",
      "_get [part] of the nth key-value pair [n]": "Obtener el [part] de la n-ésima pareja clave-valor [n]",
      "_value": "Valor",
      "_description": "Descripción",
      "_key": "Clave",
      "_No value found for key [key]": "No se encontró ningún valor para la clave [key]",
      "_No description found for key [key]": "No se encontró ninguna descripción para la clave [key]",
      "_Storage cleared": "Almacenamiento eliminado",
      "_Key [key] deleted": "Clave [key] eliminada",
      "_No key found": "No se encontró ninguna clave",
      "_project description": "Descripción del proyecto",
      "_Set the database name to [databaseName]": "Establecer el nombre de la base de datos como [databaseName]",
      "_Get current database name": "Obtener el nombre actual de la base de datos",
      "_Get current database size": "Obtener el tamaño actual de la base de datos",
      "_Is database [databaseName] exists": "¿Existe la base de datos [databaseName]?",
      "_Get all key-value pairs": "Obtener todas las parejas clave-valor",
      "_Create new database [databaseName]": "Crear una nueva base de datos [databaseName]",
      "_Delete database [databaseName]": "Eliminar la base de datos [databaseName]",
      "_Operation": "Operación",
      "_Opens the file of [TYPE] and returns as [CONTENT_TYPE]": "Abrir el archivo de [TYPE] y devolver como [CONTENT_TYPE]",
      "_openFile": "Abrir archivo",
      "_text": "Texto",
      "_binary text": "Texto binario",
      "_DataURL": "DataURL"
  },
  "fr": {
      "_Cyberexplorer's Toolbox": "Boîte à outils de Cyberexplorer",
      "_IndexedDB": "Stockage local",
      "_store [key] as [value]": "Définir la valeur de la clé [key] comme [value]",
      "_set description of [key] to [description]": "Définir la description de la clé [key] comme [description]",
      "_set project description to [description]": "Définir la description du projet comme [description]",
      "_get [type] of [key]": "Obtenir le [type] de la clé [key]",
      "_clear storage": "Vider le stockage",
      "_delete key [key]": "Supprimer la clé [key]",
      "_get number of keys": "Obtenir le nombre de clés",
      "_get [part] of the nth key-value pair [n]": "Obtenir le [part] du n-ième couple clé-valeur [n]",
      "_value": "Valeur",
      "_description": "Description",
      "_key": "Clé",
      "_No value found for key [key]": "Aucune valeur trouvée pour la clé [key]",
      "_No description found for key [key]": "Aucune description trouvée pour la clé [key]",
      "_Storage cleared": "Stockage vidé",
      "_Key [key] deleted": "Clé [key] supprimée",
      "_No key found": "Aucune clé trouvée",
      "_project description": "Description du projet",
      "_Set the database name to [databaseName]": "Définir le nom de la base de données comme [databaseName]",
      "_Get current database name": "Obtenir le nom actuel de la base de données",
      "_Get current database size": "Obtenir la taille actuelle de la base de données",
      "_Is database [databaseName] exists": "Existe-t-il une base de données [databaseName]?",
      "_Get all key-value pairs": "Obtenir toutes les paires clé-valeur",
      "_Create new database [databaseName]": "Créer une nouvelle base de données [databaseName]",
      "_Delete database [databaseName]": "Supprimer la base de données [databaseName]",
      "_Operation": "Opération",
      "_Opens the file of [TYPE] and returns as [CONTENT_TYPE]": "Ouvrir le fichier de type [TYPE] et le retourner comme [CONTENT_TYPE]",
      "_openFile": "Ouvrir le fichier",
      "_text": "Texte",
      "_binary text": "Texte binaire",
      "_DataURL": "DataURL"
  },
  "zh-tw": {
      "_Cyberexplorer's Toolbox": "賽博貓貓的工具箱",
      "_IndexedDB": "本地儲存",
      "_store [key] as [value]": "將鍵 [key] 的值設置為 [value]",
      "_set description of [key] to [description]": "將鍵 [key] 的描述設置為 [description]",
      "_set project description to [description]": "將項目描述設置為 [description]",
      "_get [type] of [key]": "獲取鍵 [key] 的 [type]",
      "_clear storage": "清除儲存空間",
      "_delete key [key]": "刪除鍵 [key]",
      "_get number of keys": "獲取鍵的數量",
      "_get [part] of the nth key-value pair [n]": "獲取第 [n] 個鍵值對的 [part]",
      "_value": "值",
      "_description": "描述",
      "_key": "鍵",
      "_No value found for key [key]": "未找到鍵 [key] 對應的值",
      "_No description found for key [key]": "未找到鍵 [key] 對應的描述",
      "_Storage cleared": "儲存空間已清除",
      "_Key [key] deleted": "鍵 [key] 已刪除",
      "_No key found": "未找到鍵",
      "_project description": "項目描述",
      "_Set the database name to [databaseName]": "將資料庫名稱設置為 [databaseName]",
      "_Get current database name": "獲取當前資料庫名稱",
      "_Get current database size": "獲取當前資料庫大小",
      "_Is database [databaseName] exists": "資料庫 [databaseName] 是否存在",
      "_Get all key-value pairs": "獲取所有鍵值對",
      "_Create new database [databaseName]": "創建新資料庫 [databaseName]",
      "_Delete database [databaseName]": "刪除資料庫 [databaseName]",
      "_Operation": "操作",
      "_Opens the file of [TYPE] and returns as [CONTENT_TYPE]": "打開 [TYPE] 類型的文件並作為 [CONTENT_TYPE] 返回",
      "_openFile": "打開文件",
      "_text": "文本",
      "_binary text": "二進制文本",
      "_DataURL": "DataURL"
  },
  "ms": {
      "_Cyberexplorer's Toolbox": "Kotak Alat Cyberexplorer",
      "_IndexedDB": "Penyimpanan Tempatan",
      "_store [key] as [value]": "Simpan [key] sebagai [value]",
      "_set description of [key] to [description]": "Tetapkan keterangan [key] kepada [description]",
      "_set project description to [description]": "Tetapkan keterangan projek kepada [description]",
      "_get [type] of [key]": "Dapatkan [type] [key]",
      "_clear storage": "Kosongkan penyimpanan",
      "_delete key [key]": "Padam [key]",
      "_get number of keys": "Dapatkan bilangan kunci",
      "_get [part] of the nth key-value pair [n]": "Dapatkan [part] pasangan kunci-nilai ke-n [n]",
      "_value": "Nilai",
      "_description": "Keterangan",
      "_key": "Kunci",
      "_No value found for key [key]": "Tiada nilai ditemui untuk kunci [key]",
      "_No description found for key [key]": "Tiada keterangan ditemui untuk kunci [key]",
      "_Storage cleared": "Penyimpanan telah dikosongkan",
      "_Key [key] deleted": "Kunci [key] telah dipadam",
      "_No key found": "Tiada kunci ditemui",
      "_project description": "Keterangan projek",
      "_Set the database name to [databaseName]": "Tetapkan nama pangkalan data kepada [databaseName]",
      "_Get current database name": "Dapatkan nama pangkalan data semasa",
      "_Get current database size": "Dapatkan saiz pangkalan data semasa",
      "_Is database [databaseName] exists": "Adakah pangkalan data [databaseName] wujud",
      "_Get all key-value pairs": "Dapatkan semua pasangan kunci-nilai",
      "_Create new database [databaseName]": "Cipta pangkalan data baru [databaseName]",
      "_Delete database [databaseName]": "Padam pangkalan data [databaseName]",
      "_Operation": "Operasi",
      "_Opens the file of [TYPE] and returns as [CONTENT_TYPE]": "Buka fail [TYPE] dan kembalikan sebagai [CONTENT_TYPE]",
      "_openFile": "Buka fail",
      "_text": "Teks",
      "_binary text": "Teks binari",
      "_DataURL": "DataURL"
  },
  "pt": {
      "_Cyberexplorer's Toolbox": "Caixa de Ferramentas do Cyberexplorer",
      "_IndexedDB": "Armazenamento Local",
      "_store [key] as [value]": "Armazenar [key] como [value]",
      "_set description of [key] to [description]": "Definir descrição de [key] como [description]",
      "_set project description to [description]": "Definir descrição do projeto como [description]",
      "_get [type] of [key]": "Obter [type] de [key]",
      "_clear storage": "Limpar armazenamento",
      "_delete key [key]": "Excluir chave [key]",
      "_get number of keys": "Obter número de chaves",
      "_get [part] of the nth key-value pair [n]": "Obter [part] do n-ésimo par chave-valor [n]",
      "_value": "Valor",
      "_description": "Descrição",
      "_key": "Chave",
      "_No value found for key [key]": "Nenhum valor encontrado para a chave [key]",
      "_No description found for key [key]": "Nenhuma descrição encontrada para a chave [key]",
      "_Storage cleared": "Armazenamento limpo",
      "_Key [key] deleted": "Chave [key] excluída",
      "_No key found": "Nenhuma chave encontrada",
      "_project description": "Descrição do projeto",
      "_Set the database name to [databaseName]": "Definir nome do banco de dados como [databaseName]",
      "_Get current database name": "Obter nome atual do banco de dados",
      "_Get current database size": "Obter tamanho atual do banco de dados",
      "_Is database [databaseName] exists": "O banco de dados [databaseName] existe?",
      "_Get all key-value pairs": "Obter todos os pares chave-valor",
      "_Create new database [databaseName]": "Criar um novo banco de dados [databaseName]",
      "_Delete database [databaseName]": "Excluir banco de dados [databaseName]",
      "_Operation": "Operação",
      "_Opens the file of [TYPE] and returns as [CONTENT_TYPE]": "Abrir o arquivo de [TYPE] e retornar como [CONTENT_TYPE]",
      "_openFile": "Abrir arquivo",
      "_text": "Texto",
      "_binary text": "Texto binário",
      "_DataURL": "DataURL"
  }
});

function createJsonResponse(fileName, content, format) {
  return JSON.stringify({
    name: fileName,
    content: content,
    format: format,
  });
}

(function (Scratch) {
  "use strict";

  if (!Scratch.extensions.unsandboxed) {
    throw new Error("indexeddb extension must be run unsandboxed");
  }

  const DB_NAME = "ScratchIndexedDB";
  const DB_VERSION = 1;
  const STORE_NAME = "scratchStore";

  class cyberexplorertoolbox {
    constructor() {
      this.databases = {};
    }

    getInfo() {
      return {
        id: "cyberexplorertoolbox",
        name: Scratch.translate("Cyberexplorer's Toolbox"),
        color1: "#2196F3",
        color2: "#1976D2",
        color3: "#1565C0",
        blocks: [
          //这一部分是IndexedDB
          {
            blockType: "label",
            text: Scratch.translate("IndexedDB"),
          },
          {
            opcode: "setDatabaseName",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("Set the database name to [databaseName]"),
            arguments: {
              databaseName: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "MyDatabase"
              }
            }
          },
          {
            opcode: "getValueOrDescription",
            blockType: Scratch.BlockType.REPORTER,
            text: Scratch.translate("get [type] of [key]"),
            arguments: {
              type: {
                type: Scratch.ArgumentType.STRING,
                menu: "typeOptions",
                defaultValue: "value"
              },
              key: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "i"
              }
            }
          },
          {
            opcode: "storeValue",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("store [key] as [value]"),
            arguments: {
              key: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "i"
              },
              value: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "1145"
              }
            }
          },
          {
            opcode: "setKeyDescription",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("set description of [key] to [description]"),
            arguments: {
              key: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "i"
              },
              description: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "description"
              }
            }
          },
          {
            opcode: "setProjectDescription",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("set project description to [description]"),
            arguments: {
              description: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "This is a Scratch project"
              }
            }
          },
          {
            opcode: "deleteKey",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("delete key [key]"),
            arguments: {
              key: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "i"
              }
            }
          },
          {
            opcode: "getCurrentDatabaseName",
            blockType: Scratch.BlockType.REPORTER,
            text: Scratch.translate("Get current database name")
          },
          {
            opcode: "getCurrentDatabaseSize",
            blockType: Scratch.BlockType.REPORTER,
            text: Scratch.translate("Get current database size")
          },
          {
            opcode: "getProjectDescription",
            blockType: Scratch.BlockType.REPORTER,
            text: Scratch.translate("project description")
          },
          {
            opcode: "getAllKeyValuePairs",
            blockType: Scratch.BlockType.REPORTER,
            text: Scratch.translate("Get all key-value pairs")
          },
          {
            opcode: "getNumberOfKeys",
            blockType: Scratch.BlockType.REPORTER,
            text: Scratch.translate("get number of keys")
          },
          {
            opcode: "getNthKeyValuePair",
            blockType: Scratch.BlockType.REPORTER,
            text: Scratch.translate("get [part] of the nth key-value pair [n]"),
            arguments: {
              part: {
                type: Scratch.ArgumentType.STRING,
                menu: "partOptions",
                defaultValue: "key"
              },
              n: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: 1
              }
            }
          },
          {
            opcode: "checkIfDatabaseExists",
            blockType: Scratch.BlockType.BOOLEAN,
            text: Scratch.translate("Is database [databaseName] exists"),
            arguments: {
              databaseName: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "MyDatabase"
              }
            }
          },
          {
            opcode: "createNewDatabase",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("Create new database [databaseName]"),
            arguments: {
              databaseName: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "NewDatabase"
              }
            }
          },
          {
            opcode: "deleteDatabase",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("Delete database [databaseName]"),
            arguments: {
              databaseName: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "MyDatabase"
              }
            }
          },
          {
            opcode: "clearStorage",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("clear storage")
          },
          "---",

          //操作标签
          {
            blockType: "label",
            text: Scratch.translate("Operation"),
          },
          {
            opcode: "ternaryOperator",
            blockType: Scratch.BlockType.REPORTER,
            text: Scratch.translate("[CONDITION]?[THEN]:[ELSE]"),
            arguments: {
              CONDITION: {
                type: Scratch.ArgumentType.BOOLEAN,
              },
              THEN: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "114"
              },
              ELSE: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "514"
              },
            },
          },
          {
            opcode: "fetchTextFromURL",
            blockType: Scratch.BlockType.REPORTER,
            text: Scratch.translate("get [URL] "),
            arguments: {
              URL: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "https://extensions.turbowarp.org/hello.txt",
              },
            },
          },
          {
            opcode: "openFileOfType",
            blockType: Scratch.BlockType.REPORTER,
            text: Scratch.translate("Opens the file of [TYPE] and returns as [CONTENT_TYPE]"),
            arguments: {
              TYPE: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "*",
              },
              CONTENT_TYPE: {
                type: Scratch.ArgumentType.MENU,
                menu: "contentType",
              },
            },
          },
          //这里应该是增加积木的地方

        ],

        menus: {
          typeOptions: {
            items: [
              { text: Scratch.translate("value"), value: "value" },
              { text: Scratch.translate("description"), value: "description" }
            ]
          },
          partOptions: {
            items: [
              { text: Scratch.translate("key"), value: "key" },
              { text: Scratch.translate("value"), value: "value" }
            ]
          },
          contentType: {
            items: [
              {text: Scratch.translate("text"), value: "text"},
              {text: Scratch.translate("binary text"), value: "binary"},
              {text: Scratch.translate("DataURL"), value: "dataURL"},
            ]
          }
        }
      };
    }

    async setDatabaseName(args) {
      this.dbName = args.databaseName;
    }
    //设置当前的数据库ID

    async getCurrentDatabaseName() {
      return this.dbName;
    }
    //获取当前切换到的数据库ID

    async getCurrentDatabaseSize() {
      const db = await this._openDB();
      const transaction = db.transaction([STORE_NAME], "readonly");
      const store = transaction.objectStore(STORE_NAME);
      return new Promise((resolve, reject) => {
        const request = store.count();
        request.onsuccess = () => {
          const estimatedSizeBytes = request.result * 100;
          const estimatedSizeKB = (estimatedSizeBytes / 1024).toFixed(2);
          resolve(estimatedSizeKB);
        };
        request.onerror = () => reject(request.error);
      });
    }
    //估计当前数据库占用的大小

    async checkIfDatabaseExists(args) {
      const dbName = args.databaseName;
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(dbName, 1);
        request.onerror = () => resolve(false);
        request.onsuccess = () => resolve(true);
        request.onupgradeneeded = () => resolve(false);
      });
    }
    //侦测某个数据库是否存在

    async getProjectDescription() {
      const db = await this._openDB();
      const transaction = db.transaction([STORE_NAME], "readonly");
      const store = transaction.objectStore(STORE_NAME);
      return new Promise((resolve, reject) => {
        const request = store.get("projectDescription");
        request.onsuccess = () => {
          if (request.result) {
            resolve(request.result.description);
          } else {
            resolve(Scratch.translate(""));
          }
        };
        request.onerror = () => reject(request.error);
      });
    }
    //获取项目的介绍，其实这也是一个键值对
    //键是"projectDescription"，这同样可以用在获取值的块中

    async createNewDatabase(args) {
      const dbName = args.databaseName;
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(dbName, 1);
        request.onerror = (event) => reject(event.target.error);
        request.onsuccess = () => resolve();
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: "key" });
          }
        };
      });
    }
    //创建一个数据库，当然，在切换到某个数据库的时候会自动创建新数据库

    async deleteDatabase(args) {
      const dbName = args.databaseName;
      return new Promise((resolve, reject) => {
        const request = indexedDB.deleteDatabase(dbName);
        request.onerror = (event) => reject(event.target.error);
        request.onsuccess = () => resolve();
      });
    }
    //删除某个数据库

    async getAllKeyValuePairs() {
      const db = await this._openDB();
      const transaction = db.transaction([STORE_NAME], "readonly");
      const store = transaction.objectStore(STORE_NAME);
      return new Promise((resolve, reject) => {
        const request = store.getAll();
        request.onsuccess = () => {
          const result = {};
          request.result.forEach(item => {
            result[item.key] = item.value;
          });
          resolve(JSON.stringify(result, null, 2)); // 将结果转换为格式化的 JSON 字符串
        };
        request.onerror = () => reject(request.error);
      });
    }
    //获取所有的键值对

    async _openDB(databaseName = DB_NAME) {
      if (this.databases[databaseName]) {
        return this.databases[databaseName];
      }

      return new Promise((resolve, reject) => {
        const request = indexedDB.open(databaseName, DB_VERSION);
        request.onerror = (event) => reject(event.target.error);
        request.onsuccess = (event) => {
          this.databases[databaseName] = event.target.result;
          resolve(event.target.result);
        };
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: "key" });
          }
        };
      });
    }
    //这是打开数据库的一个函数
    
    async storeValue(args) {
      const { key, value } = args;
      const db = await this._openDB();
      const transaction = db.transaction([STORE_NAME], "readwrite");
      const store = transaction.objectStore(STORE_NAME);
      const request = store.put({ key, value }); // 存储键和值
      return new Promise((resolve, reject) => {
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    async setKeyDescription(args) {
      const { key, description } = args;
      const db = await this._openDB();
      const transaction = db.transaction([STORE_NAME], "readwrite");
      const store = transaction.objectStore(STORE_NAME);
      const request = store.put({ key, description }); // 存储键和描述
      return new Promise((resolve, reject) => {
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    async setProjectDescription(args) {
      const { description } = args;
      const db = await this._openDB();
      const transaction = db.transaction([STORE_NAME], "readwrite");
      const store = transaction.objectStore(STORE_NAME);
      const request = store.put({ key: "projectDescription", description }); // 存储项目描述
      return new Promise((resolve, reject) => {
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    async getValueOrDescription(args) {
      const { key, type } = args;
      const db = await this._openDB();
      const transaction = db.transaction([STORE_NAME], "readonly");
      const store = transaction.objectStore(STORE_NAME);
      return new Promise((resolve, reject) => {
        const request = store.get(key);
        request.onsuccess = () => {
          if (request.result) {
            if (type === "value") {
              resolve(request.result.value); // 返回存储的值
            } else if (type === "description") {
              resolve(request.result.description); // 返回存储的描述
            }
          } else {
            resolve(undefined); // 如果键不存在，返回 undefined
          }
        };
        request.onerror = () => reject(request.error);
      });
    }

    async deleteKey(args) {
      const { key } = args;
      const db = await this._openDB();
      const transaction = db.transaction([STORE_NAME], "readwrite");
      const store = transaction.objectStore(STORE_NAME);
      return new Promise((resolve, reject) => {
        const request = store.delete(key);
        request.onsuccess = () => {
          console.log(Scratch.translate("Key [key] deleted", { key }));
          resolve();
        };
        request.onerror = () => reject(request.error);
      });
    }
    //删除某一个键值对

    async getNumberOfKeys() {
      const db = await this._openDB();
      const transaction = db.transaction([STORE_NAME], "readonly");
      const store = transaction.objectStore(STORE_NAME);
      return new Promise((resolve, reject) => {
        const request = store.count();
        request.onsuccess = () => {
          resolve(request.result);
        };
        request.onerror = () => reject(request.error);
      });
    }
    //获取当前有多少个键值对

    async getNthKeyValuePair(args) {
      const { part, n } = args;
      const db = await this._openDB();
      const transaction = db.transaction([STORE_NAME], "readonly");
      const store = transaction.objectStore(STORE_NAME);
      return new Promise((resolve, reject) => {
        const request = store.openCursor();
        let count = 0;
        request.onsuccess = (event) => {
          const cursor = event.target.result;
          if (cursor) {
            count += 1;
            if (count === n) {
              if (part === "key") {
                resolve(cursor.key);
              } else if (part === "value") {
                resolve(cursor.value.value);
              }
              return; // 停止继续遍历
            }
            cursor.continue();
          } else {
            resolve(undefined); // 如果没有找到，返回 undefined
          }
        };
        request.onerror = () => reject(request.error);
      });
    }
    //遍历来进行获取第n个键值对

    async clearStorage() {
      const db = await this._openDB();
      const transaction = db.transaction([STORE_NAME], "readwrite");
      const store = transaction.objectStore(STORE_NAME);
      return new Promise((resolve, reject) => {
        const request = store.clear();
        request.onsuccess = () => {
          console.log(Scratch.translate("Storage cleared"));
          resolve();
        };
        request.onerror = () => reject(request.error);
      });
    }

    async _openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = (event) => reject(event.target.error);
        request.onsuccess = (event) => resolve(event.target.result);
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: "key" });
          }
        };
      });
    }
    //诶，等等，我之前是不是写过一个_openDB了

    ternaryOperator(args) {
      return args.CONDITION ? args.THEN : args.ELSE; //实现三元运算符
    }

    async fetchTextFromURL(args) {
      const url = args.URL;
  
      try {
        const response = await fetch(url);
        const data = await response.text();
        return data;
      } catch (error) {
        console.error("获取文本时出错:", error);
        return ""; // 返回空字符串以表示错误
      }
    }

    async openFileOfType(args) {
      const type = args.TYPE;
      const contentType = args.CONTENT_TYPE;
  
      const input = document.createElement("input");
      input.type = "file";
      input.style.display = "none";
      input.accept = type !== "*" ? type : "";
  
      input.click();
  
      return new Promise((resolve, reject) => {
        input.onchange = (event) => {
          const file = event.target.files[0];
          if (!file) {
            reject("没有选择文件。");
            return;
          }
  
          let content;
          const reader = new FileReader();
  
          switch (contentType) {
            case "text":
              reader.readAsText(file);
              reader.onload = () => {
                content = reader.result;
                resolve(createJsonResponse(file.name, content, type));
              };
              reader.onerror = () => {
                reject("读取文件时出错。");
              };
              break;
            case "binary":
              reader.readAsBinaryString(file);
              reader.onload = () => {
                content = reader.result;
                resolve(createJsonResponse(file.name, content, type));
              };
              reader.onerror = () => {
                reject("读取文件时出错。");
              };
              break;
            case "dataURL":
              reader.readAsDataURL(file);
              reader.onload = () => {
                content = reader.result;
                resolve(createJsonResponse(file.name, content, type));
              };
              reader.onerror = () => {
                reject("读取文件时出错。");
              };
              break;
            default:
              reject("不支持的内容类型。");
          }
        };
      });
    }
  }
  //读取文件，不管我怎么改都不能把取消选择文件的BUG修好，好像File也有这个问题？

  Scratch.extensions.register(new cyberexplorertoolbox());
})(Scratch);